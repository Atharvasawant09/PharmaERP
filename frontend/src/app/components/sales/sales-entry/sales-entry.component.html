<div class="sales-entry-container">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" [routerLink]="['/dashboard']">
        <i class="fas fa-pills me-2"></i>PharmaERP
      </a>
      <span class="navbar-text text-white">
        <i class="fas fa-shopping-cart me-2"></i>Sales Entry
      </span>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <button class="btn btn-outline-primary me-3" (click)="goBack()">
          <i class="fas fa-arrow-left me-2"></i>Back
        </button>
        <h2 class="d-inline-block mb-0">New Sales Transaction</h2>
      </div>
    </div>

    <!-- Sales Form -->
    <div class="row">
      <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <form [formGroup]="salesForm" (ngSubmit)="onSubmit()">
              <!-- Customer & Payment Section -->
              <div class="row mb-4">
                <!-- ENHANCED CUSTOMER SELECTION WITH ADD BUTTON -->
                <div class="col-md-6">
                  <label class="form-label fw-bold">
                    <i class="fas fa-user me-2"></i>Customer
                    <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <select
                      class="form-select"
                      formControlName="customerId"
                      [class.is-invalid]="salesForm.get('customerId')?.invalid && salesForm.get('customerId')?.touched">
                      <option value="">Select Customer</option>
                      <option *ngFor="let customer of customers" [value]="customer.CustomerId">
                        {{ customer.CustomerName }} - {{ customer.Mobile }}
                      </option>
                    </select>
                    <!-- ADD NEW CUSTOMER BUTTON -->
                    <button
                      class="btn btn-success"
                      type="button"
                      (click)="openCustomerModal()"
                      title="Add New Customer">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="salesForm.get('customerId')?.invalid && salesForm.get('customerId')?.touched">
                    Please select a customer
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-bold">
                    <i class="fas fa-credit-card me-2"></i>Payment Type
                    <span class="text-danger">*</span>
                  </label>
                  <select class="form-select" formControlName="paymentType">
                    <option value="Cash">Cash</option>
                    <option value="Card">Card</option>
                    <option value="UPI">UPI</option>
                  </select>
                </div>
              </div>

              <!-- Items Section (KEEP AS IS) -->
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Products
                  </h5>
                  <button
                    type="button"
                    class="btn btn-sm btn-success"
                    (click)="addItem()"
                    [disabled]="loading">
                    <i class="fas fa-plus me-2"></i>Add Item
                  </button>
                </div>

                <!-- Items Table -->
                <div class="table-responsive">
                  <table class="table table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 40%">Product</th>
                        <th style="width: 15%">Quantity</th>
                        <th style="width: 20%">Rate (₹)</th>
                        <th style="width: 20%">Total (₹)</th>
                        <th style="width: 5%"></th>
                      </tr>
                    </thead>
                    <tbody formArrayName="items">
                      <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
                        <td>
                          <select
                            class="form-select form-select-sm"
                            formControlName="productId"
                            (change)="onProductChange(i)"
                            [class.is-invalid]="item.get('productId')?.invalid && item.get('productId')?.touched">
                            <option value="">Select Product</option>
                            <option
                              *ngFor="let product of getAvailableProducts(i)"
                              [value]="product.ProductId">
                              {{ product.ProductName }} (Stock: {{ product.StockQty }})
                            </option>
                          </select>
                        </td>
                        <td>
                          <input
                            type="number"
                            class="form-control form-control-sm"
                            formControlName="quantity"
                            min="1"
                            (input)="onQuantityChange(i)"
                            [class.is-invalid]="item.get('quantity')?.invalid && item.get('quantity')?.touched">
                        </td>
                        <td>
                          <input
                            type="number"
                            class="form-control form-control-sm"
                            formControlName="rate"
                            readonly>
                        </td>
                        <td>
                          <input
                            type="number"
                            class="form-control form-control-sm fw-bold"
                            formControlName="lineTotal"
                            readonly>
                        </td>
                        <td class="text-center">
                          <button
                            type="button"
                            class="btn btn-sm btn-danger"
                            (click)="removeItem(i)"
                            [disabled]="items.length === 1">
                            <i class="fas fa-times"></i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="d-grid">
                <button
                  type="submit"
                  class="btn btn-primary btn-lg"
                  [disabled]="submitting || loading">
                  <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
                  <i *ngIf="!submitting" class="fas fa-check me-2"></i>
                  {{ submitting ? 'Processing...' : 'Complete Sale' }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Summary Card (KEEP AS IS) -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-calculator me-2"></i>Sale Summary
            </h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-3">
              <span class="text-muted">Total Items:</span>
              <span class="fw-bold">{{ items.length }}</span>
            </div>
            <div class="d-flex justify-content-between mb-3">
              <span class="text-muted">Subtotal:</span>
              <span class="fw-bold">₹{{ calculateTotal().toFixed(2) }}</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between">
              <span class="fw-bold fs-5">Grand Total:</span>
              <span class="fw-bold fs-4 text-primary">₹{{ calculateTotal().toFixed(2) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD CUSTOMER MODAL -->
  <div class="modal fade show d-block" *ngIf="showCustomerModal" [class.show]="showCustomerModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="fas fa-user-plus me-2"></i>Add New Customer
          </h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeCustomerModal()"></button>
        </div>
        <form [formGroup]="customerForm" (submit)="addCustomer()">
          <div class="modal-body">
            <!-- Customer Name -->
            <div class="mb-3">
              <label class="form-label fw-bold">
                Customer Name <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                formControlName="customerName"
                placeholder="Enter customer name"
                [class.is-invalid]="customerName?.invalid && customerName?.touched">
              <div class="invalid-feedback">
                Customer name is required
              </div>
            </div>

            <!-- Mobile Number -->
            <div class="mb-3">
              <label class="form-label fw-bold">Mobile Number</label>
              <input
                type="tel"
                class="form-control"
                formControlName="mobile"
                placeholder="10-digit mobile number"
                maxlength="10"
                [class.is-invalid]="mobile?.invalid && mobile?.touched">
              <div class="invalid-feedback">
                Enter valid 10-digit mobile number
              </div>
            </div>

            <!-- Email (Optional) -->
            <div class="mb-3">
              <label class="form-label fw-bold">Email (Optional)</label>
              <input
                type="email"
                class="form-control"
                formControlName="email"
                placeholder="customer@example.com"
                [class.is-invalid]="email?.invalid && email?.touched">
              <div class="invalid-feedback">
                Enter valid email address
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="closeCustomerModal()"
              [disabled]="addingCustomer">
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-success"
              [disabled]="addingCustomer">
              <span *ngIf="addingCustomer" class="spinner-border spinner-border-sm me-2"></span>
              <i *ngIf="!addingCustomer" class="fas fa-check me-2"></i>
              {{ addingCustomer ? 'Adding...' : 'Add Customer' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show" *ngIf="showCustomerModal"></div>
</div>
